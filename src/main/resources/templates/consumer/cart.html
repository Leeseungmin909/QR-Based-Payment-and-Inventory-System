<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장바구니</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f9f9f9; }
        .container { max-width: 600px; margin: 0 auto; background-color: white; min-height: 100vh; }
        header { padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        h1 { margin: 0; font-size: 24px; }

        /* 장바구니 목록 */
        .cart-list { list-style: none; padding: 0; margin: 0; }
        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .item-details { flex-grow: 1; }
        .item-name { font-size: 16px; font-weight: bold; }
        .item-price { font-size: 14px; color: #555; }

        /* 수량 조절 버튼 스타일 */
        .item-quantity {
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
        }
        .item-quantity .quantity-btn {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f5f5f5;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            font-size: 18px;
        }
        .item-quantity .quantity-text {
            padding: 0 10px;
            min-width: 20px;
            text-align: center;
        }
        .item-quantity .remove-btn {
            margin-left: 15px;
            font-size: 20px;
            text-decoration: none;
            color: #aaa;
        }

        .empty-cart { padding: 50px 20px; text-align: center; color: #888; }
        .error-box { background-color: #f8d7da; color: #721c24; padding: 10px 15px; border: 1px solid #f5c6cb; border-radius: 4px; margin: 15px; }
        .purchase-footer { position: fixed; bottom: 0; left: 0; right: 0; max-width: 600px; margin: 0 auto; padding: 15px 20px; background-color: white; border-top: 1px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .total-amount { font-size: 18px; font-weight: bold; text-align: right; margin-bottom: 10px; }
        .purchase-footer button { display: block; width: 100%; padding: 15px; font-size: 18px; font-weight: bold; color: white; background-color: #007bff; border: none; border-radius: 8px; cursor: pointer; }
        .purchase-footer button:disabled { background-color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>장바구니</h1>
    </header>

    <div th:if="${errorMessage}" class="error-box">
        <p th:text="${errorMessage}">[재고 오류 등이 여기에 표시]</p>
    </div>

    <div th:if="${#lists.isEmpty(cartItems)}" class="empty-cart">
        <p>장바구니가 비어있습니다.</p>
        <p>상품의 QR 코드를 스캔하여 장바구니에 추가하세요.</p>
    </div>

    <ul class="cart-list" th:unless="${#lists.isEmpty(cartItems)}">
        <li class="cart-item" th:each="entry : ${cartItems}">
            <div class="item-details">
                <div class="item-name" th:text="${entry.key.name}">상품 이름</div>
                <div class="item-price" th:text="${entry.key.price} + '원'">1,500원</div>
            </div>

            <div class="item-quantity">
                <a class="quantity-btn" th:href="@{/consumer/cart/subtract/{id}(id=${entry.key.productId})}">-</a>
                <span class="quantity-text" th:text="${entry.value}">1</span>
                <a class="quantity-btn" th:href="@{/consumer/cart/add/{id}(id=${entry.key.productId})}">+</a>
                <a class="remove-btn" th:href="@{/consumer/cart/remove/{id}(id=${entry.key.productId})}">×</a>
            </div>
        </li>
    </ul>

    <div style="height: 150px;"></div>
</div>

<footer class="purchase-footer">
    <div class="total-amount">
        <span>총 합계:</span>
        <span th:text="${totalAmount} + '원'">0원</span>
    </div>
    <button id="purchaseBtn" th:disabled="${#lists.isEmpty(cartItems)}">
        결제하기
    </button>
</footer>

<script>
    // 브라우저가 뒤로가기 감지시 페이지 새로고침
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            window.location.reload();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const purchaseBtn = document.getElementById('purchaseBtn');

        purchaseBtn.addEventListener('click', () => {

            if (confirm('카카오페이로 결제를 진행하시겠습니까?')) {

                // 결제 준비 API 호출
                fetch('/consumer/payment/ready', {
                    method: 'POST'
                })
                    .then(response => response.json().then(body => ({ ok: response.ok, body: body })))
                    .then(res => {
                        if (res.ok) {
                            // 성공 시 카카오톡 앱 실행 URL로 이동
                            const redirectUrl = res.body.next_redirect_mobile_url;
                            window.location.href = redirectUrl;
                        } else {
                            // 실패
                            alert("결제 준비 실패:\n\n* " + res.body.error);
                        }
                    })
                    .catch(error => {
                        console.error('결제 준비 중 오류 발생:', error);
                        alert('서버 통신에 실패했습니다.');
                    });
            }
        });
    });
</script>
</body>
</html>