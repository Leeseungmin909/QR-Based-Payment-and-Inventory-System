<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>관리자 - 주문 관리</title>
  <style>
    body { font-family: sans-serif; margin: 0; }
    .container { display: flex; }
    .sidebar {
      width: 200px;
      background-color: #f4f4f4;
      padding: 20px;
      height: 100vh;
      border-right: 1px solid #ddd;
    }
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar-menu .category-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-top: 15px;
      margin-bottom: 10px;
      padding: 0 5px;
    }
    .sidebar-menu li {
      margin-bottom: 5px;
    }
    .sidebar-menu li a {
      display: block;
      padding: 10px 15px;
      text-decoration: none;
      color: #555;
      border-radius: 5px;
      margin-left: 10px;
    }
    .sidebar-menu li a.active {
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }
    .sidebar-menu li a:hover:not(.active) {
      background-color: #e9e9e9;
    }

    .content { flex-grow: 1; padding: 30px; }
    .product-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .product-table th, .product-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    .product-table th { background-color: #f8f8f8; }
    .product-table td .btn { padding: 5px 10px; text-decoration: none; border-radius: 3px; font-size: 12px; margin-right: 5px; }
    .btn-refund { background-color: #17a2b8; color: white; cursor: pointer; }
    .btn-refunded { background-color: #6c757d; color: white; cursor: not-allowed; }

    .btn-detail {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    .search-bar { margin-bottom: 20px; }
    .search-bar input[type="number"] { padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
    .search-bar button { padding: 8px 12px; background-color: #333; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .error-box {
      background-color: #f8d7da;
      color: #721c24;
      padding: 10px 15px;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <nav class="sidebar">
    <ul class="sidebar-menu">
      <li class="category-title">관리자</li>
      <li><a href="/admin/products">상품 관리</a></li>
      <li><a href="/admin/purchases" class="active">주문/환불 관리</a></li>
    </ul>
  </nav>

  <main class="content">

    <div class="search-bar">
      <form action="/admin/purchases/search" method="get">
        <input type="number" name="purchaseId" placeholder="환불하실 주문 ID를 입력해주세요...">
        <button type="submit">검색</button>
      </form>
    </div>

    <div th:if="${errorMessage}" class="error-box">
      <p th:text="${errorMessage}">[검색 오류가 여기에 표시됩니다]</p>
    </div>

    <h1>주문/환불 관리</h1>

    <table class="product-table">
      <thead>
      <tr>
        <th>주문 ID</th>
        <th>주문 시간</th>
        <th>총액</th>
        <th>주문 상태</th>
        <th>관리</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="purchase : ${purchases}">
        <td th:text="${purchase.purchaseId}">1001</td>
        <td th:text="${#temporals.format(purchase.purchaseDate, 'yyyy-MM-dd HH:mm')}"></td>
        <td th:text="${purchase.totalAmount} + '원'">3000원</td>
        <td th:text="${purchase.state == T(min.example.QRp.domain.PurchaseState).COMPLETED} ? '구매완료' : '환불'">
          구매완료
        </td>
        <td>
          <a class="btn btn-detail"
             th:href="@{/admin/purchases/search(purchaseId=${purchase.purchaseId})}">
            상세보기
          </a>

          <a th:if="${purchase.state == T(min.example.QRp.domain.PurchaseState).COMPLETED}"
             class="btn btn-refund"
             th:data-purchase-id="${purchase.purchaseId}">
            환불
          </a>
          <span th:if="${purchase.state == T(min.example.QRp.domain.PurchaseState).REFUNDED}"
                class="btn btn-refunded">
                                환불 완료
                            </span>
        </td>
      </tr>
      </tbody>
    </table>

  </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {

    // 환불
    const refundButtons = document.querySelectorAll('.btn-refund');

    refundButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        const purchaseId = event.target.dataset.purchaseId;

        if (confirm('정말로 이 주문(ID: ' + purchaseId + ')을 환불하시겠습니까?\n(상품 재고가 다시 추가됩니다.)')) {

          fetch(`/admin/purchases/${purchaseId}/refund`, {
            method: 'POST'
          })
                  .then(response => {
                    return response.text().then(text => {
                      return { ok: response.ok, status: response.status, text: text };
                    });
                  })
                  .then(res => {
                    if (res.ok) {
                      alert('✅ ' + res.text);
                      location.reload();
                    } else {
                      try {
                        const errorBody = JSON.parse(res.text);
                        handleErrorResponse(errorBody);
                      } catch (e) {
                        alert('서버 오류가 발생했습니다.');
                      }
                    }
                  })
                  .catch(error => handleFetchError(error, '환불 처리'));
        }
      });
    });

    // 공통 에러 처리 함수
    function handleErrorResponse(errorBody) {
      let errorMsg = "요청 처리 중 오류가 발생했습니다:\n\n";
      if (errorBody.error) {
        errorMsg += `* ${errorBody.error}`;
      } else {
        for (const field in errorBody) {
          errorMsg += `* ${errorBody[field]}\n`;
        }
      }
      alert(errorMsg);
    }

    function handleFetchError(error, actionName) {
      console.error(`'${actionName}' 중 심각한 오류 발생:`, error);
      alert(`${actionName} 중 서버 통신에 실패했습니다.`);
    }
  });
</script>
</body>
</html>