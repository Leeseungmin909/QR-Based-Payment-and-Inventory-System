<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì - ì£¼ë¬¸ ê²€ìƒ‰ ê²°ê³¼</title>
  <style>
    body { font-family: sans-serif; margin: 0; }
    .container { display: flex; }
    .sidebar { width: 200px; background-color: #f4f4f4; padding: 20px; height: 100vh; border-right: 1px solid #ddd; }
    .sidebar-menu { list-style: none; padding: 0; margin: 0; }
    .sidebar-menu .category-title { font-size: 18px; font-weight: bold; color: #333; margin-top: 15px; margin-bottom: 10px; padding: 0 5px; }
    .sidebar-menu li { margin-bottom: 5px; }
    .sidebar-menu li a { display: block; padding: 10px 15px; text-decoration: none; color: #555; border-radius: 5px; margin-left: 10px; }
    .sidebar-menu li a.active { background-color: #007bff; color: white; font-weight: bold; }
    .sidebar-menu li a:hover:not(.active) { background-color: #e9e9e9; }
    .sidebar-menu .category-divider { height: 1px; background-color: #ddd; margin: 20px 0; }

    .content { flex-grow: 1; padding: 30px; }
    .product-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .product-table th, .product-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    .product-table th { background-color: #f8f8f8; }
    .button-bar { margin-top: 20px; display: flex; justify-content: flex-end; }
    .button-bar .btn { padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; text-decoration: none; }

    .product-table td .btn { padding: 5px 10px; text-decoration: none; border-radius: 3px; font-size: 12px; margin-right: 5px; }
    .btn-refund { background-color: #17a2b8; color: white; cursor: pointer; }
    .btn-refunded { background-color: #6c757d; color: white; cursor: not-allowed; }

    .item-table { width: 60%; margin-top: 10px; }
  </style>
</head>
<body>
<div class="container">
  <nav class="sidebar">
    <ul class="sidebar-menu">
      <li class="category-title">ê´€ë¦¬ì</li>
      <li><a href="/admin/products">ìƒí’ˆ ê´€ë¦¬</a></li>
      <li><a href="/admin/purchases" class="active">ì£¼ë¬¸/í™˜ë¶ˆ ê´€ë¦¬</a></li>
      <li class="category-divider"></li>
      <li class="category-title">ì†Œë¹„ì</li>
    </ul>
  </nav>

  <main class="content">
    <h1>ì£¼ë¬¸ ê²€ìƒ‰ ê²°ê³¼</h1>
    <p><strong>ì£¼ë¬¸ ID: <span th:text="${purchase.purchaseId}">1</span></strong>ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.</p>

    <table class="product-table">
      <thead>
      <tr>
        <th>ì£¼ë¬¸ ID</th>
        <th>ì£¼ë¬¸ ì‹œê°„</th>
        <th>ì´ì•¡</th>
        <th>ì£¼ë¬¸ ìƒíƒœ</th>
        <th>ê´€ë¦¬</th> </tr>
      </thead>
      <tbody>
      <tr th:object="${purchase}">
        <td th:text="*{purchaseId}"></td>
        <td th:text="${#temporals.format(purchase.purchaseDate, 'yyyy-MM-dd HH:mm')}"></td>
        <td th:text="|*{totalAmount}ì›|"></td>
        <td th:text="*{state == T(min.example.QRp.domain.PurchaseState).COMPLETED} ? 'êµ¬ë§¤ì™„ë£Œ' : 'í™˜ë¶ˆ'"></td>
        <td>
          <a th:if="*{state == T(min.example.QRp.domain.PurchaseState).COMPLETED}"
             class="btn btn-refund"
             th:data-purchase-id="*{purchaseId}">
            í™˜ë¶ˆ
          </a>
          <span th:if="*{state == T(min.example.QRp.domain.PurchaseState).REFUNDED}"
                class="btn btn-refunded">
                                í™˜ë¶ˆ ì™„ë£Œ
                            </span>
        </td>
      </tr>
      </tbody>
    </table>

    <h3>ì£¼ë¬¸ ìƒì„¸ ë‚´ì—­</h3>
    <table class="product-table item-table">
      <thead>
      <tr>
        <th>ìƒí’ˆëª…</th>
        <th>ì£¼ë¬¸ ê°€ê²©</th>
        <th>ì£¼ë¬¸ ìˆ˜ëŸ‰</th>
        <th>í•©ê³„</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="item : ${purchase.purchaseItems}">
        <td th:text="${item.productName}"></td>
        <td th:text="${item.orderPrice} + 'ì›'"></td>
        <td th:text="${item.orderQuantity}"></td>
        <td th:text="${item.itemTotalAmount} + 'ì›'"></td>
      </tr>
      </tbody>
    </table>

    <div class="button-bar">
      <a href="/admin/purchases" class="btn">ì „ì²´ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {

    // í™˜ë¶ˆ
    const refundButtons = document.querySelectorAll('.btn-refund');

    refundButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        const purchaseId = event.target.dataset.purchaseId;

        if (confirm('ì •ë§ë¡œ ì´ ì£¼ë¬¸(ID: ' + purchaseId + ')ì„ í™˜ë¶ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìƒí’ˆ ì¬ê³ ê°€ ë‹¤ì‹œ ì¶”ê°€ë©ë‹ˆë‹¤.)')) {

          fetch(`/admin/purchases/${purchaseId}/refund`, {
            method: 'POST'
          })
                  .then(response => {
                    return response.text().then(text => {
                      return { ok: response.ok, status: response.status, text: text };
                    });
                  })
                  .then(res => {
                    if (res.ok) {
                      alert('âœ… ' + res.text);
                      // í™˜ë¶ˆ ì„±ê³µ ì‹œ ëª©ë¡ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
                      window.location.href = '/admin/purchases';
                    } else {
                      try {
                        const errorBody = JSON.parse(res.text);
                        handleErrorResponse(errorBody);
                      } catch (e) {
                        alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                      }
                    }
                  })
                  .catch(error => handleFetchError(error, 'í™˜ë¶ˆ ì²˜ë¦¬'));
        }
      });
    });

    // ê³µí†µ ì—ëŸ¬ ì²˜ë¦¬ í•¨ìˆ˜
    function handleErrorResponse(errorBody) {
      let errorMsg = "ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n";
      if (errorBody.error) {
        errorMsg += `* ${errorBody.error}`;
      } else {
        for (const field in errorBody) {
          errorMsg += `* ${errorBody[field]}\n`;
        }
      }
      alert(errorMsg);
    }

    function handleFetchError(error, actionName) {
      console.error(`'${actionName}' ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ:`, error);
      alert(`ğŸš¨ ${actionName} ì¤‘ ì„œë²„ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
    }
  });
</script>
</body>
</html>